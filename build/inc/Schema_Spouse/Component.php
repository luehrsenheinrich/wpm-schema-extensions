<?php
/**
 * WpmSchema\i18n\Component class
 * Adds the 'Spouse' schema graph piece to the output generated by Yoast SEO.
 *
 * @package wpmschema
 */

namespace WpMunich\wpmschema\Schema_Spouse;
use WpMunich\wpmschema\Component_Interface;
use function add_action;
use function load_plugin_textdomain;
use \YoastSEO;

/**
 * A class to handle textdomains and other i18n related logic..
 */
class Component implements Component_Interface {

	/**
	 * Gets the unique identifier for the plugin component.
	 *
	 * @return string Component slug.
	 */
	public function get_slug() {
		return 'schema_spouse';
	}

	/**
	 * Adds the action and filter hooks to integrate with WordPress.
	 */
	public function initialize() {
		add_action( 'wpm_schema_user_profile', array( $this, 'extend_user_profile' ) );
		add_action( 'wpm_schema_user_update', array( $this, 'update_user_profile' ) );
		add_filter( 'wpseo_schema_graph_pieces', array( $this, 'add_graph_pieces' ), 11, 2 );
	}

	/**
	 * Extend the existing user profile settings.
	 *
	 * @param WP_User $user The current WP_User object.
	 */
	public function extend_user_profile( $user ) {
		?>
		<tr class="user-description-wrap">
			<th><label for="wpm-spouse"><?php _e( 'Spouse', 'wpm-schema' ); ?></label></th>
			<td>
				<?php
					wp_dropdown_users(
						array(
							'show_option_none' => __( 'None', 'wpm-schema' ),
							'echo'             => true,
							'exclude'          => isset( $user->ID ) ? array( $user->ID ) : array(),
							'name'             => 'wpm-spouse',
							'selected'         => get_user_meta( $user->ID, 'wpm-spouse', true ),
						)
					);
				?>
				<p class="description"><?php _e( 'Select the WordPress User, that shall be displayed as your spouse in the Yoast SEO Schema graph.', 'wpm-schema' ); ?></p>
			</td>
		</tr>
		<?php
	}

	/**
	 * Update the user meta data.
	 *
	 * @param  int $user_id The user ID.
	 *
	 * @return void
	 */
	public function update_user_profile( $user_id ) {
		update_user_meta( $user_id, 'wpm-spouse', sanitize_text_field( $_POST['wpm-spouse'] ) );
	}

	/**
	 * Adds Schema pieces to our output.
	 *
	 * @param array                 $pieces  Graph pieces to output.
	 * @param \WPSEO_Schema_Context $context Object with context variables.
	 *
	 * @return array Graph pieces to output.
	 */
	public function add_graph_pieces( $pieces, $context ) {
		$pieces[] = new Spouse( $context );

		return $pieces;
	}
}
